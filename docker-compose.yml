services:
  # GATEWAY (NGINX - HTTPS)
  nginx:
    image: nginx:alpine
    container_name: ledger_gateway
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs/letsencrypt:/etc/nginx/certs:ro
      - ./certs/webroot:/var/www/certbot:ro
    depends_on:
      - ledger_api
      - cert_seed
    networks:
      ledger_net:
        ipv4_address: 172.28.0.50

  # BACKEND (API)
  ledger_api:
    build: .
    container_name: ledger_api
    command: uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload
    restart: always
    ports:
      - "8000:8000"
    volumes:
      - .:/app
      - models_data:/app/models
      - logs_data:/app/logs
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - SECRET_KEY=${SECRET_KEY}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - VAULT_ADDR=${VAULT_ADDR}
      - VAULT_TOKEN=${VAULT_TOKEN}
      - VAULT_KV_MOUNT=${VAULT_KV_MOUNT}
      - VAULT_ENCRYPTION_KEY_PATH=${VAULT_ENCRYPTION_KEY_PATH}
      - VAULT_ENCRYPTION_KEY_FIELD=${VAULT_ENCRYPTION_KEY_FIELD}
      - WATCHFILES_FORCE_POLLING=true
      - SEED_DEV=${SEED_DEV}
      - SEED_EMAIL=${SEED_EMAIL}
      - SEED_PASSWORD=${SEED_PASSWORD}
      - SEED_CPF=${SEED_CPF}
      - SEED_NAME=${SEED_NAME}
      - LOG_DIR=/app/logs
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=ledger-api
    depends_on:
      - ledger_db
      - ledger_redis
      - ledger_vault
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import requests; requests.get('http://localhost:8000/health', timeout=2).raise_for_status()\""]
      interval: 15s
      timeout: 5s
      retries: 5
    networks:
      - ledger_net

  # DATABASE
  ledger_db:
    image: postgres:15-alpine
    container_name: ledger_db
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_HOST_AUTH_METHOD=${POSTGRES_HOST_AUTH_METHOD}
    command: >
      postgres -c wal_level=replica -c max_wal_senders=5 -c hot_standby=on -c hba_file=/etc/postgresql/pg_hba.conf
    volumes:
      - postgres_data_v7:/var/lib/postgresql/data
      - ./postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
    networks:
      - ledger_net
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d ledger_core"]
      interval: 10s
      timeout: 5s
      retries: 6

  ledger_db_replica:
    image: postgres:15-alpine
    container_name: ledger_db_replica
    user: postgres
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    command: >
      /bin/sh -c "until pg_isready -h ledger_db; do sleep 2; done;
      rm -rf /var/lib/postgresql/data/*;
      pg_basebackup -h ledger_db -D /var/lib/postgresql/data -U postgres -Fp -Xs -P -R;
      postgres"
    volumes:
      - postgres_replica_data:/var/lib/postgresql/data
    depends_on:
      - ledger_db
    networks:
      - ledger_net
    ports:
      - "5434:5432"

  ledger_db_region2:
    image: postgres:15-alpine
    container_name: ledger_db_region2
    user: postgres
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    command: >
      /bin/sh -c "until pg_isready -h ledger_db; do sleep 2; done;
      rm -rf /var/lib/postgresql/data/*;
      pg_basebackup -h ledger_db -D /var/lib/postgresql/data -U postgres -Fp -Xs -P -R;
      postgres"
    volumes:
      - postgres_region2_data:/var/lib/postgresql/data
    depends_on:
      - ledger_db
    networks:
      - ledger_net
    ports:
      - "5435:5432"

  # CACHE
  ledger_redis:
    image: redis:alpine
    container_name: ledger_redis
    ports:
      - "6379:6379"
    networks:
      - ledger_net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 6

  # WORKER (CELERY)
  ledger_worker:
    build: .
    container_name: ledger_worker
    command: celery -A src.infra.celery_app.celery_app worker -l info
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - SECRET_KEY=${SECRET_KEY}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - VAULT_ADDR=${VAULT_ADDR}
      - VAULT_TOKEN=${VAULT_TOKEN}
      - VAULT_KV_MOUNT=${VAULT_KV_MOUNT}
      - VAULT_ENCRYPTION_KEY_PATH=${VAULT_ENCRYPTION_KEY_PATH}
      - VAULT_ENCRYPTION_KEY_FIELD=${VAULT_ENCRYPTION_KEY_FIELD}
    depends_on:
      - ledger_db
      - ledger_redis
      - ledger_vault
    networks:
      - ledger_net
    volumes:
      - .:/app
      - models_data:/app/models
      - logs_data:/app/logs

  ledger_beat:
    build: .
    container_name: ledger_beat
    command: celery -A src.infra.celery_app.celery_app beat -l info
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - SECRET_KEY=${SECRET_KEY}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - VAULT_ADDR=${VAULT_ADDR}
      - VAULT_TOKEN=${VAULT_TOKEN}
      - VAULT_KV_MOUNT=${VAULT_KV_MOUNT}
      - VAULT_ENCRYPTION_KEY_PATH=${VAULT_ENCRYPTION_KEY_PATH}
      - VAULT_ENCRYPTION_KEY_FIELD=${VAULT_ENCRYPTION_KEY_FIELD}
    depends_on:
      - ledger_db
      - ledger_redis
      - ledger_vault
    networks:
      - ledger_net
    volumes:
      - .:/app
      - models_data:/app/models
      - logs_data:/app/logs

  # VAULT (SECRETS)
  ledger_vault:
    image: hashicorp/vault:1.18
    container_name: ledger_vault
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=${VAULT_DEV_ROOT_TOKEN_ID}
      - VAULT_DEV_LISTEN_ADDRESS=${VAULT_DEV_LISTEN_ADDRESS}
    ports:
      - "8200:8200"
    cap_add:
      - IPC_LOCK
    networks:
      - ledger_net

  ledger_vault_init:
    image: hashicorp/vault:1.18
    container_name: ledger_vault_init
    depends_on:
      - ledger_vault
    environment:
      - VAULT_ADDR=${VAULT_ADDR}
      - VAULT_TOKEN=${VAULT_TOKEN}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "sleep 2 &&
       vault kv put secret/ledger/crypto encryption_key=${ENCRYPTION_KEY} &&
       echo 'Vault seeded.'"
    networks:
      - ledger_net

  # ACME (Let's Encrypt local - Pebble)
  pebble:
    image: ghcr.io/letsencrypt/pebble:latest
    container_name: ledger_pebble
    command: ["-config", "test/config/pebble-config.json"]
    ports:
      - "14000:14000"
      - "15000:15000"
    extra_hosts:
      - "ledger.local:172.28.0.50"
    networks:
      - ledger_net

  pebble_challtestsrv:
    image: ghcr.io/letsencrypt/pebble-challtestsrv:latest
    container_name: ledger_pebble_chall
    ports:
      - "8055:8055"
    networks:
      - ledger_net

  cert_seed:
    image: alpine:3.20
    container_name: ledger_cert_seed
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "apk add --no-cache openssl &&
       mkdir -p /etc/letsencrypt/live/ledger.local &&
       openssl req -x509 -nodes -newkey rsa:2048 -keyout /etc/letsencrypt/live/ledger.local/privkey.pem -out /etc/letsencrypt/live/ledger.local/fullchain.pem -days 7 -subj /CN=ledger.local"
    volumes:
      - ./certs/letsencrypt:/etc/letsencrypt
    networks:
      - ledger_net
    restart: "no"

  ledger_certbot:
    image: certbot/certbot:v2.11.0
    container_name: ledger_certbot
    depends_on:
      - pebble
      - pebble_challtestsrv
      - nginx
    volumes:
      - ./certs/letsencrypt:/etc/letsencrypt
      - ./certs/webroot:/var/www/certbot
    command: >
      certonly --non-interactive --agree-tos
      --email dev@ledger.local
      --server https://pebble:14000/dir
      --webroot -w /var/www/certbot
      -d ledger.local
      --no-eff-email
      --rsa-key-size 2048
      --preferred-challenges http
    networks:
      - ledger_net
    restart: "no"

  # OBSERVABILIDADE - PROMETHEUS
  prometheus:
    image: prom/prometheus
    container_name: ledger_prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./prometheus/alerts.yml:/etc/prometheus/alerts.yml
    ports:
      - "9090:9090"
    networks:
      - ledger_net

  # OBSERVABILIDADE - GRAFANA
  grafana:
    image: grafana/grafana
    container_name: ledger_grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
    networks:
      - ledger_net

  alertmanager:
    image: prom/alertmanager
    container_name: ledger_alertmanager
    volumes:
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml
    ports:
      - "9093:9093"
    networks:
      - ledger_net

  alert_router:
    build: .
    container_name: ledger_alert_router
    command: uvicorn src.infra.alert_router:app --host 0.0.0.0 --port 5001
    ports:
      - "5001:5001"
    networks:
      - ledger_net

  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: ledger_mailhog
    ports:
      - "8025:8025"
      - "1025:1025"
    networks:
      - ledger_net

  sms_gateway:
    build: .
    container_name: ledger_sms_gateway
    command: uvicorn src.infra.sms_gateway:app --host 0.0.0.0 --port 6001
    ports:
      - "6001:6001"
    networks:
      - ledger_net

  whatsapp_gateway:
    build: .
    container_name: ledger_whatsapp_gateway
    command: uvicorn src.infra.whatsapp_gateway:app --host 0.0.0.0 --port 6002
    ports:
      - "6002:6002"
    networks:
      - ledger_net

  push_gateway:
    build: .
    container_name: ledger_push_gateway
    command: uvicorn src.infra.push_gateway:app --host 0.0.0.0 --port 6003
    ports:
      - "6003:6003"
    networks:
      - ledger_net

  slack_mock:
    build: .
    container_name: ledger_slack_mock
    command: uvicorn src.infra.slack_mock:app --host 0.0.0.0 --port 6004
    ports:
      - "6004:6004"
    networks:
      - ledger_net

  pagerduty_mock:
    build: .
    container_name: ledger_pagerduty_mock
    command: uvicorn src.infra.pagerduty_mock:app --host 0.0.0.0 --port 6005
    ports:
      - "6005:6005"
    networks:
      - ledger_net

  jaeger:
    image: jaegertracing/all-in-one:1.58
    container_name: ledger_jaeger
    ports:
      - "16686:16686"
      - "4317:4317"
    networks:
      - ledger_net

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.14.1
    container_name: ledger_elasticsearch
    environment:
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - discovery.type=single-node
      - xpack.security.enabled=false
    volumes:
      - ./observability/elk/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
    ports:
      - "9200:9200"
    networks:
      - ledger_net

  logstash:
    image: docker.elastic.co/logstash/logstash:8.14.1
    container_name: ledger_logstash
    volumes:
      - ./observability/elk/logstash.conf:/usr/share/logstash/pipeline/logstash.conf
    ports:
      - "5044:5044"
    depends_on:
      - elasticsearch
    networks:
      - ledger_net

  kibana:
    image: docker.elastic.co/kibana/kibana:8.14.1
    container_name: ledger_kibana
    volumes:
      - ./observability/elk/kibana.yml:/usr/share/kibana/config/kibana.yml
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    networks:
      - ledger_net

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.14.1
    container_name: ledger_filebeat
    user: root
    command: ["-e", "--strict.perms=false"]
    volumes:
      - ./observability/elk/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - logs_data:/var/log/ledger
    depends_on:
      - logstash
    networks:
      - ledger_net

  node_exporter:
    image: prom/node-exporter
    container_name: ledger_node_exporter
    ports:
      - "9100:9100"
    networks:
      - ledger_net

  redis_exporter:
    image: oliver006/redis_exporter
    container_name: ledger_redis_exporter
    environment:
      - REDIS_ADDR=redis://ledger_redis:6379
    ports:
      - "9121:9121"
    networks:
      - ledger_net

  postgres_exporter:
    image: prometheuscommunity/postgres-exporter
    container_name: ledger_postgres_exporter
    environment:
      - DATA_SOURCE_NAME=${DATA_SOURCE_NAME}
    ports:
      - "9187:9187"
    networks:
      - ledger_net

  warehouse_db:
    image: postgres:15-alpine
    container_name: ledger_warehouse_db
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${WAREHOUSE_POSTGRES_DB}
    ports:
      - "5433:5432"
    volumes:
      - warehouse_data:/var/lib/postgresql/data
    networks:
      - ledger_net

  airflow:
    image: apache/airflow:2.9.3
    container_name: ledger_airflow
    environment:
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=${AIRFLOW__DATABASE__SQL_ALCHEMY_CONN}
      - AIRFLOW_CONN_WAREHOUSE_DB=${AIRFLOW_CONN_WAREHOUSE_DB}
    ports:
      - "8080:8080"
    volumes:
      - ./analytics/airflow/dags:/opt/airflow/dags
    command: >
      /bin/sh -c "airflow db init &&
      airflow users create --username ${AIRFLOW_ADMIN_USER} --password ${AIRFLOW_ADMIN_PASSWORD} --firstname ${AIRFLOW_ADMIN_FIRSTNAME} --lastname ${AIRFLOW_ADMIN_LASTNAME} --role Admin --email ${AIRFLOW_ADMIN_EMAIL} &&
      airflow webserver"
    depends_on:
      - warehouse_db
    networks:
      - ledger_net

  airflow_scheduler:
    image: apache/airflow:2.9.3
    container_name: ledger_airflow_scheduler
    environment:
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=${AIRFLOW__DATABASE__SQL_ALCHEMY_CONN}
      - AIRFLOW_CONN_WAREHOUSE_DB=${AIRFLOW_CONN_WAREHOUSE_DB}
    volumes:
      - ./analytics/airflow/dags:/opt/airflow/dags
    command: >
      /bin/sh -c "airflow db init && airflow scheduler"
    depends_on:
      - warehouse_db
    networks:
      - ledger_net

  metabase:
    image: metabase/metabase:latest
    container_name: ledger_metabase
    ports:
      - "3001:3000"
    depends_on:
      - warehouse_db
    networks:
      - ledger_net

  dbt:
    image: ghcr.io/dbt-labs/dbt-postgres:1.8.2
    container_name: ledger_dbt
    volumes:
      - ./analytics/dbt:/usr/app
    working_dir: /usr/app
    command: ["dbt", "run", "--profiles-dir", "/usr/app"]
    depends_on:
      - warehouse_db
    networks:
      - ledger_net

  minio:
    image: minio/minio:latest
    container_name: ledger_minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      - ledger_net

  minio_dr:
    image: minio/minio:latest
    container_name: ledger_minio_dr
    command: server /data --console-address ":9003"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    ports:
      - "9002:9000"
      - "9003:9003"
    volumes:
      - minio_dr_data:/data
    networks:
      - ledger_net

  minio_init:
    image: minio/mc:latest
    container_name: ledger_minio_init
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "mc alias set local http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD} &&
       mc mb -p local/ledger-backups || true"
    depends_on:
      - minio
    networks:
      - ledger_net

  minio_dr_init:
    image: minio/mc:latest
    container_name: ledger_minio_dr_init
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "mc alias set local http://minio_dr:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD} &&
       mc mb -p local/ledger-backups || true"
    depends_on:
      - minio_dr
    networks:
      - ledger_net

  minio_init_audit:
    image: minio/mc:latest
    container_name: ledger_minio_init_audit
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "mc alias set local http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD} &&
       mc mb -p local/ledger-audit-archive || true"
    depends_on:
      - minio
    networks:
      - ledger_net

  backup:
    image: alpine:3.20
    container_name: ledger_backup
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "apk add --no-cache postgresql-client gzip aws-cli &&
       /scripts/backup_loop.sh"
    environment:
      - PGHOST=${PGHOST}
      - PGUSER=${PGUSER}
      - PGPASSWORD=${PGPASSWORD}
      - PGDATABASE=${PGDATABASE}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_BUCKET=${S3_BUCKET}
      - S3_ENDPOINT_DR=${S3_ENDPOINT_DR}
      - S3_BUCKET_DR=${S3_BUCKET_DR}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    volumes:
      - ./scripts:/scripts
    depends_on:
      - ledger_db
      - minio
      - minio_dr
    networks:
      - ledger_net

  audit_archive:
    build: .
    container_name: ledger_audit_archive
    command: python scripts/archive_audit.py
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AUDIT_ARCHIVE_S3_BUCKET=${AUDIT_ARCHIVE_S3_BUCKET}
      - AUDIT_ARCHIVE_S3_ENDPOINT=${S3_ENDPOINT}
    depends_on:
      - ledger_db
      - minio
    networks:
      - ledger_net

  audit_archive_scheduler:
    build: .
    container_name: ledger_audit_archive_scheduler
    command: /bin/sh -c "while true; do python scripts/archive_audit.py; sleep 2592000; done"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AUDIT_ARCHIVE_S3_BUCKET=${AUDIT_ARCHIVE_S3_BUCKET}
      - AUDIT_ARCHIVE_S3_ENDPOINT=${S3_ENDPOINT}
    depends_on:
      - ledger_db
      - minio
    networks:
      - ledger_net

volumes:
  postgres_data_v7:
  postgres_replica_data:
  postgres_region2_data:
  models_data:
  logs_data:
  minio_data:
  minio_dr_data:
  warehouse_data:

networks:
  ledger_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
